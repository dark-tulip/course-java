# Kafka topics and partitions

- партиции хранятся на диске;
- партиции разделены на сегменты;
- партиции как единицы параллелизации хранения данных в топике;
- данные можно удалять только целыми сегментами;
- данные удаляются целыми сегментами либо по времени, либо по размеру;
- `retention.bytes=-1` (размер партиции ограничем размером диска)
- `retention.ms=604800000` - 1 неделя (данные хранятся в партиции)
- для каждого сегмента на диске хранится три файла `segment{basic_offset, data, index, timeindex}`
```
basic_offset is 0000123456789 (segment name)
data is         0000123456789.log (append only подход записи)
index is        0000123456789.index (чтобы быстро искать по offset)
timeindex is    0000123456789.timeindex (у каждого события есть время)
```
- сообщение можно быстро найти по его offset-у

# Kafka brokers
- контроллер координирует работу кластера
- один из брокеров в кластере выбирается контроллером
- при replication_factor=3 каждая партиция будет продублирована на одном из брокеров (если брокеров 3)
- чтобы писать данные в партиции, нужно выбрать leader брокера для партиции
  - например, broker 1 is leader for partition 0
  - broker 2 is leader for partition 1
  - each partition should have leader broker
  - репликация с лидера на другие брокеры (**followers**)
  - `ISR` - in sync replica, реплика синхронизированная с лидером
- когда падает лидер, лидером становится один из ISR реплик, когда упавший лидер входит в строй, он догоняет (восстанавливает данные) с нового лидера
- когда в одном брокере больше лидеров чем на других, кафка делает перебалансировку лидера на другой брокер
- у каждой партиции есть свой лидер
- сообщения пишутся в лидер
- данные реплицируются между брокерами
- автоматическим фэйловером лидера занимается kafka controller

# Kafka Producers
- выбирает партицию куда записывать
- отвечает за гарантию доставки
- тюнинг производительности (отправлять batch-ами, по времени, по размеру, по кол-ву сообщений, использоватние сжатия*)
- 
### Гарантии доставки событий продюсеру
```C#
enum Acks {
 None = 0,
 Leader = 1,
 All=-1
}
```
если будем ждать подтверждения от всех реплик, запись застрянет, to avoid use:
(PS сколько готовы потерять брокеров, и продолжить работу)
```
Topic config: min.insync.replicas = 2
```
# Kafka consumers
- на консюмер подписываются
- читают каждые Х секунд*
- ВАЖНО! по умолчанию консюмится пачка, но на прикладной код отдается ПО ОДНОМУ СОБЫТИЮ
- при восстановлении - начинает обратно читать с последнего `commit offset `
    - at least oncle (process - then commit)
    - mostly once (commit then process)

## Connect to conductor cluster
1. 

## create topic

```bash

```
